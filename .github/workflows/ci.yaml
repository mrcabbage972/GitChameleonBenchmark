name: CI

on:
  pull_request:
  push:
    branches: [main]

jobs:
  ci:
    runs-on: ubuntu-latest

    steps:
      - name: Check out code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v3
        with:
          python-version: '3.9'

      - name: Install Poetry
        run: |
          curl -sSL https://install.python-poetry.org | python3 -
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Configure Poetry
        run: |
          poetry config virtualenvs.in-project true

      - name: Install dependencies with Poetry
        run: |
          poetry install

      - name: Run linters
        run: |
          make lint-all

  docker-build:
    permissions:
        contents: read # Needed for actions/checkout
        packages: write # Needed to push to GitHub Container Registry
    runs-on: ubuntu-latest
    needs: ci 
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
      - name: Log in to Docker Hub
        # This action handles logging into the registry using your secrets
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_TOKEN }}

      - name: Check out code
        uses: actions/checkout@v3

      - name: Build and push Docker image to Docker Hub
        # This action builds the image from your Dockerfile and pushes it
        uses: docker/build-push-action@v5
        with:
          context: . # '.' assumes your Dockerfile is in the root of your repo
          push: true
          tags: ${{ secrets.DOCKER_HUB_USERNAME }}/gitchameleon:latest
        

